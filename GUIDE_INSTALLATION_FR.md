# ü™Ç Guide d'Installation 1BIP - Syst√®me de Reconnaissance Faciale
## 1√®re Brigade d'Infanterie Parachutiste - Forces Arm√©es Royales Marocaines

---

## ‚ö†Ô∏è IMPORTANT - √Ä Propos des Erreurs 401/500 au Premier D√©marrage

### Pourquoi ces erreurs se produisent-elles?

Les erreurs **401 Unauthorized** et **500 Internal Server Error** que vous voyez au premier d√©marrage sont **NORMALES** et attendues. Voici pourquoi:

1. **CompreFace a besoin de temps pour initialiser** - La base de donn√©es PostgreSQL doit cr√©er les tables et charger les mod√®les d'IA
2. **Les services d√©marrent dans un ordre sp√©cifique** - Certains services d√©pendent d'autres qui ne sont pas encore pr√™ts
3. **C'est un processus de premi√®re installation** - Cela ne se produira qu'une seule fois

### Solution: Patience et Ordre Correct

**Attendez 2-3 minutes** apr√®s `docker-compose up -d` avant d'acc√©der √† l'interface.

---

## üìã Installation Compl√®te √âtape par √âtape

### √âtape 1: D√©marrer Tous les Services

```bash
cd /path/to/CompreFaceModeling

# D√©marrer tous les services
docker-compose up -d

# Attendez que tous les services soient pr√™ts (IMPORTANT!)
echo "Attente de l'initialisation des services... Veuillez patienter 3 minutes"
sleep 180

# V√©rifier que tous les services sont en cours d'ex√©cution
docker-compose ps
```

**Vous devriez voir:**
- `compreface-postgres-db` - Running
- `compreface-admin` - Running
- `compreface-api` - Running
- `compreface-core` - Running
- `compreface-ui` - Running
- `1bip-camera-service` - Running (optionnel si cam√©ra configur√©e)
- `1bip-dashboard` - Running

### √âtape 2: V√©rifier les Logs (R√©soudre les Probl√®mes)

Si vous avez toujours des erreurs apr√®s 3 minutes:

```bash
# V√©rifier les logs de chaque service
docker-compose logs compreface-admin
docker-compose logs compreface-api
docker-compose logs compreface-core
docker-compose logs compreface-postgres-db

# Si vous voyez "waiting for PostgreSQL to start" - c'est normal, attendez encore
# Si vous voyez "database migration complete" - c'est bon!
```

### √âtape 3: Acc√©der √† l'Interface CompreFace

```bash
# Ouvrir dans votre navigateur
open http://localhost:8000
```

**Page de connexion:** Vous verrez la page de connexion de CompreFace

**PREMI√àRE FOIS - Cr√©er un compte administrateur:**

1. Cliquez sur **"Sign Up"** (Cr√©er un compte)
2. Remplissez:
   - **Email:** admin@1bip.ma (ou votre email)
   - **Mot de passe:** ChoisissezUnMotDePasseSecurise123!
   - **Confirmation:** ChoisissezUnMotDePasseSecurise123!
3. Cliquez sur **"Sign Up"**
4. Connectez-vous avec vos identifiants

---

## üîë Configuration de la Cl√© API (CRITIQUE - 100% Hors Ligne!)

### ‚ùó CLARIFICATION IMPORTANTE SUR LA CL√â API

**La cl√© API CompreFace n'est PAS d'internet!**

- ‚úÖ La cl√© API est **g√©n√©r√©e par VOTRE propre instance CompreFace** sur votre serveur
- ‚úÖ **100% hors ligne** - Aucune connexion internet n√©cessaire
- ‚úÖ C'est juste une cl√© de s√©curit√© entre vos propres services
- ‚úÖ Tout fonctionne sur **votre r√©seau local uniquement**

### Comment Obtenir Votre Cl√© API (Sur Votre Serveur)

#### Option 1: Interface Web CompreFace (Recommand√©e)

1. **Connectez-vous √† CompreFace** - http://localhost:8000

2. **Cr√©er une Application de Reconnaissance:**
   - Allez dans **"Applications"**
   - Cliquez **"Add New Application"**
   - Nom: `1BIP Base Principale` (ou le nom de votre unit√©)
   - Cliquez **"Create"**

3. **Activer le Service de Reconnaissance Faciale:**
   - Dans votre application, cliquez sur **"Services"**
   - Trouvez **"Recognition"**
   - Cliquez **"Enable"** ou **"Configure"**

4. **Copier la Cl√© API:**
   - Vous verrez **"API Key"** affich√©
   - Cliquez sur l'ic√¥ne üìã pour copier
   - **EXEMPLE:** `00000000-0000-0000-0000-000000000001`

5. **Enregistrer la Cl√© API dans votre Configuration:**

```bash
# √âditer le fichier de configuration de la cam√©ra
nano camera-service/config/camera_config.env

# Remplacer la ligne:
COMPREFACE_API_KEY=your_api_key_here_from_compreface_ui

# Par votre vraie cl√© API:
COMPREFACE_API_KEY=00000000-0000-0000-0000-000000000001

# Sauvegarder: Ctrl+O, Enter, Ctrl+X
```

6. **Red√©marrer le Service Cam√©ra:**

```bash
docker-compose restart 1bip-camera-service
```

---

## üë• Organisation du Personnel par Unit√© et D√©partement

### Structure Recommand√©e

CompreFace vous permet d'organiser le personnel de mani√®re hi√©rarchique:

```
1BIP (1√®re Brigade d'Infanterie Parachutiste)
‚îÇ
‚îú‚îÄ‚îÄ Application 1: "1BIP - Compagnie Alpha"
‚îÇ   ‚îú‚îÄ‚îÄ Personne: CPT. Ahmed Mansouri
‚îÇ   ‚îú‚îÄ‚îÄ Personne: LT. Mohammed Benani
‚îÇ   ‚îú‚îÄ‚îÄ Personne: SGT. Youssef Khalil
‚îÇ   ‚îî‚îÄ‚îÄ ... (300-500 personnes)
‚îÇ
‚îú‚îÄ‚îÄ Application 2: "1BIP - Compagnie Bravo"
‚îÇ   ‚îú‚îÄ‚îÄ Personne: CPT. Hassan Ziani
‚îÇ   ‚îú‚îÄ‚îÄ Personne: LT. Omar Tazi
‚îÇ   ‚îî‚îÄ‚îÄ ... (300-500 personnes)
‚îÇ
‚îú‚îÄ‚îÄ Application 3: "1BIP - Compagnie Charlie"
‚îÇ   ‚îî‚îÄ‚îÄ ... (300-500 personnes)
‚îÇ
‚îú‚îÄ‚îÄ Application 4: "1BIP - √âtat-Major"
‚îÇ   ‚îú‚îÄ‚îÄ Personne: COL. Rachid Alami (Commandant)
‚îÇ   ‚îú‚îÄ‚îÄ Personne: MAJ. Karim Benjelloun
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îî‚îÄ‚îÄ Application 5: "1BIP - Services de Soutien"
    ‚îî‚îÄ‚îÄ ...
```

### M√©thode 1: Une Application par Unit√©/D√©partement

**Avantages:**
- ‚úÖ Organisation claire
- ‚úÖ Cl√©s API s√©par√©es par unit√©
- ‚úÖ Contr√¥le d'acc√®s granulaire
- ‚úÖ Rapports et statistiques par unit√©

**Comment Cr√©er:**

1. **Pour Chaque Unit√©/D√©partement:**
   ```
   Nom Application: "1BIP - Compagnie Alpha"
   Description: "Compagnie Alpha - Zone Op√©rationnelle Nord"
   ```

2. **Activer le Service de Reconnaissance** pour chaque application

3. **Ajouter le Personnel √† l'Application:**
   - Cliquez sur l'application
   - Cliquez **"Subjects"** (Personnes)
   - Cliquez **"Add Subject"**
   - Nom: `CPT_Ahmed_Mansouri` (Format: GRADE_Prenom_Nom)
   - T√©l√©chargez **3-5 photos** de la personne (diff√©rents angles)

### M√©thode 2: Utiliser les Metadata pour Organiser

**Une application avec m√©tadonn√©es:**

```
Application: "1BIP - Personnel de la Brigade"

Personne 1:
- Nom: CPT_Ahmed_Mansouri
- M√©tadonn√©es: {
    "unite": "Compagnie Alpha",
    "grade": "Capitaine",
    "matricule": "1BIP-2024-001",
    "fonction": "Commandant de Compagnie"
  }

Personne 2:
- Nom: LT_Mohammed_Benani
- M√©tadonn√©es: {
    "unite": "Compagnie Alpha",
    "grade": "Lieutenant",
    "matricule": "1BIP-2024-002",
    "fonction": "Chef de Section"
  }
```

**Avantages:**
- ‚úÖ Gestion centralis√©e
- ‚úÖ Recherche et filtrage faciles
- ‚úÖ Rapports flexibles
- ‚úÖ Une seule cl√© API

---

## üìπ Configuration de la Cam√©ra Hikvision

### √âtape 1: Trouver l'URL RTSP de votre Cam√©ra

**Format RTSP Hikvision:**
```
rtsp://username:password@IP_ADDRESS:554/Streaming/Channels/101
```

**Exemple concret:**
```
rtsp://admin:Morocco2025@192.168.1.100:554/Streaming/Channels/101
```

**Param√®tres:**
- `username`: Nom d'utilisateur de la cam√©ra (g√©n√©ralement `admin`)
- `password`: Mot de passe de votre cam√©ra Hikvision
- `IP_ADDRESS`: Adresse IP de la cam√©ra sur votre r√©seau local (ex: 192.168.1.100)
- `554`: Port RTSP (standard)
- `/Streaming/Channels/101`: Canal principal (haute r√©solution 8MP)
  - `/Streaming/Channels/102`: Canal secondaire (r√©solution inf√©rieure)

### √âtape 2: Tester la Connexion RTSP

```bash
# Installer VLC si pas d√©j√† install√©
# Sur macOS:
brew install vlc

# Tester le stream RTSP
vlc rtsp://admin:VotreMotDePasse@192.168.1.100:554/Streaming/Channels/101
```

Si vous voyez la vid√©o dans VLC, votre URL RTSP est correcte!

### √âtape 3: Configurer le Service Cam√©ra

```bash
# √âditer la configuration
nano camera-service/config/camera_config.env
```

**Param√®tres CRITIQUES √† modifier:**

```bash
# URL de Votre Cam√©ra Hikvision
CAMERA_RTSP_URL=rtsp://admin:VotreMotDePasse@192.168.1.100:554/Streaming/Channels/101

# Nom et Localisation
CAMERA_NAME=1BIP Portail Principal
CAMERA_LOCATION=1BIP Base - Point de Contr√¥le Alpha

# Cl√© API (copi√©e depuis CompreFace UI - √âTAPE CRITIQUE!)
COMPREFACE_API_KEY=00000000-0000-0000-0000-000000000001

# Performance pour M3 Max (ajuster selon votre mat√©riel)
FRAME_SKIP=2              # Traiter 1 image sur 2 (augmenter pour CPU plus lent)
FRAME_WIDTH=2560          # 4K pour M3 Max (r√©duire √† 1920 pour mat√©riel moins puissant)
FRAME_HEIGHT=1440
MAX_FACES_PER_FRAME=20    # D√©tection multi-visages

# S√©curit√© - Seuil de Similarit√© (plus √©lev√© = plus strict)
SIMILARITY_THRESHOLD=0.88 # 88% recommand√© pour usage militaire
                          # 0.85 = moins strict (plus de faux positifs)
                          # 0.90 = tr√®s strict (peut rejeter vrais positifs)
```

### √âtape 4: Red√©marrer les Services

```bash
# Red√©marrer le service cam√©ra
docker-compose restart 1bip-camera-service

# V√©rifier les logs
docker-compose logs -f 1bip-camera-service
```

**Vous devriez voir:**
```
‚úÖ Connected to RTSP stream: rtsp://admin:****@192.168.1.100:554/Streaming/Channels/101
‚úÖ Frame size: 2560x1440
‚úÖ CompreFace API connection successful
üé• Camera service running...
```

---

## üìä Acc√©der au Tableau de Bord

```bash
# Ouvrir le tableau de bord
open http://localhost:5000
```

**Vous verrez:**
- ü™ñ Acc√®s Total Aujourd'hui
- ‚úÖ Personnel Autoris√©
- üö® Alertes de S√©curit√©
- ü™Ç Parachutistes Actifs
- üìπ Cam√©ras de Surveillance

**Fonctionnalit√©s:**
- üî¥ Moniteur en Direct (actualisation auto toutes les 10 secondes)
- üìã Suivi du Personnel (arriv√©es/d√©parts)
- üö® Alertes d'Acc√®s Non Autoris√©
- üìπ √âtat des Cam√©ras
- üìä Rapports d'Op√©rations (export CSV)

---

## üîß Flux de Travail Complet

### Workflow Quotidien

```
1. MATIN - D√©marrage du Syst√®me
   ‚îî‚îÄ> docker-compose up -d
   ‚îî‚îÄ> Attendre 2-3 minutes
   ‚îî‚îÄ> V√©rifier dashboard: http://localhost:5000

2. AJOUT DE NOUVEAU PERSONNEL
   ‚îî‚îÄ> Acc√©der √† CompreFace UI: http://localhost:8000
   ‚îî‚îÄ> Choisir l'application (unit√©/d√©partement)
   ‚îî‚îÄ> Ajouter une personne ("Subject")
   ‚îî‚îÄ> T√©l√©charger 3-5 photos (face, profil gauche, profil droit)
   ‚îî‚îÄ> La personne est maintenant dans la base de donn√©es

3. RECONNAISSANCE EN TEMPS R√âEL
   ‚îî‚îÄ> La cam√©ra d√©tecte automatiquement les visages
   ‚îî‚îÄ> Compare avec la base de donn√©es locale
   ‚îî‚îÄ> Si reconnu ‚Üí Acc√®s autoris√© (enregistr√© dans les logs)
   ‚îî‚îÄ> Si non reconnu ‚Üí Alerte d'intrusion (notification)

4. SURVEILLANCE ET RAPPORTS
   ‚îî‚îÄ> Dashboard en direct: http://localhost:5000
   ‚îî‚îÄ> Voir tous les acc√®s du jour
   ‚îî‚îÄ> Filtrer les alertes
   ‚îî‚îÄ> Exporter les rapports CSV

5. FIN DE JOURN√âE
   ‚îî‚îÄ> Les donn√©es sont sauvegard√©es automatiquement
   ‚îî‚îÄ> Option: docker-compose down (si vous voulez arr√™ter)
```

---

## ‚úÖ Checklist de V√©rification

- [ ] Docker et Docker Compose install√©s
- [ ] CompreFace d√©marr√© et accessible (http://localhost:8000)
- [ ] Compte administrateur cr√©√©
- [ ] Application de reconnaissance cr√©√©e
- [ ] Cl√© API copi√©e et configur√©e dans `camera_config.env`
- [ ] URL RTSP de la cam√©ra test√©e avec VLC
- [ ] Service cam√©ra d√©marr√© et connect√©
- [ ] Dashboard accessible (http://localhost:5000)
- [ ] Au moins 1 personne test ajout√©e avec photos
- [ ] Test de reconnaissance effectu√© avec succ√®s

---

## üö® D√©pannage - Probl√®mes Courants

### Probl√®me 1: Erreur 401/500 sur la Page de Connexion

**Cause:** Services pas encore compl√®tement initialis√©s

**Solution:**
```bash
# Attendez 3-5 minutes
sleep 300

# V√©rifier l'√©tat de la base de donn√©es
docker-compose logs compreface-postgres-db | grep "ready"

# Si vous voyez "database system is ready to accept connections" - c'est bon!

# Red√©marrer si n√©cessaire
docker-compose restart
```

### Probl√®me 2: Service Cam√©ra Ne Se Connecte Pas

**Cause:** Cl√© API manquante ou incorrecte

**Solution:**
```bash
# 1. V√©rifier que la cl√© API est dans la config
cat camera-service/config/camera_config.env | grep COMPREFACE_API_KEY

# 2. Si vous voyez "your_api_key_here" - vous devez la remplacer!
# 3. Retournez √† l'√©tape "Configuration de la Cl√© API" ci-dessus
# 4. Copiez la vraie cl√© depuis CompreFace UI
# 5. Red√©marrez le service
docker-compose restart 1bip-camera-service
```

### Probl√®me 3: Cam√©ra RTSP Ne Se Connecte Pas

**Diagnostic:**
```bash
# V√©rifier les logs de la cam√©ra
docker-compose logs 1bip-camera-service

# Tester manuellement avec VLC
vlc rtsp://admin:password@IP:554/Streaming/Channels/101
```

**Solutions:**
- ‚úÖ V√©rifiez l'adresse IP de la cam√©ra (ping 192.168.1.100)
- ‚úÖ V√©rifiez le mot de passe de la cam√©ra
- ‚úÖ V√©rifiez que le port 554 est ouvert
- ‚úÖ Essayez le canal 102 au lieu de 101
- ‚úÖ V√©rifiez que RTSP est activ√© dans les param√®tres de la cam√©ra

### Probl√®me 4: D√©tection Trop de Faux Positifs

**Cause:** Seuil de similarit√© trop bas

**Solution:**
```bash
# √âditer la config
nano camera-service/config/camera_config.env

# Augmenter le seuil
SIMILARITY_THRESHOLD=0.90  # Au lieu de 0.85

# Red√©marrer
docker-compose restart 1bip-camera-service
```

### Probl√®me 5: Performance Lente sur M3 Max

**Solution:**
```bash
# V√©rifier que MPS GPU est utilis√©
docker-compose logs compreface-core | grep "MPS"

# Si pas de MPS, voir le guide M3_MAX_GPU_GUIDE.md
cat M3_MAX_GPU_GUIDE.md

# Ajuster les param√®tres de performance dans .env
nano .env

# Augmenter:
compreface_api_java_options=-Xmx12g  # Si vous avez 64GB RAM
uwsgi_processes=6                     # Plus de workers
```

---

## üîê S√©curit√© - Recommandations

### 1. Changer le Mot de Passe de la Base de Donn√©es

```bash
# √âditer .env AVANT le premier d√©marrage
nano .env

# Changer:
postgres_password=VotreMotDePasseTresSecurise2025!
```

### 2. R√©seau Isol√© (Air-Gapped)

Ce syst√®me peut fonctionner **compl√®tement hors ligne**:

- ‚úÖ Aucune connexion internet n√©cessaire
- ‚úÖ Toutes les communications sont locales
- ‚úÖ Aucune donn√©e ne quitte votre serveur
- ‚úÖ Peut √™tre d√©ploy√© sur r√©seau isol√© militaire

### 3. Sauvegardes

```bash
# Sauvegarder la base de donn√©es
docker-compose exec compreface-postgres-db pg_dump -U postgres morocco_1bip_frs > backup_$(date +%Y%m%d).sql

# Sauvegarder les images et configurations
tar -czf backup_1bip_$(date +%Y%m%d).tar.gz camera-service/ dashboard-service/ .env docker-compose.yml
```

---

## üìû Support

Pour des questions ou probl√®mes:

1. **V√©rifier les logs:** `docker-compose logs [service-name]`
2. **Consulter la documentation CompreFace:** https://github.com/exadel-inc/CompreFace
3. **Fichiers de r√©f√©rence:**
   - `QUICK_START.md` - Guide de d√©marrage rapide
   - `M3_MAX_GPU_GUIDE.md` - Guide d'optimisation M3 Max
   - `OFFLINE_OPERATION_GUIDE.md` - Guide op√©ration hors ligne

---

## üá≤üá¶ 1BIP - 1√®re Brigade d'Infanterie Parachutiste
### Forces Arm√©es Royales Marocaines - Troupes A√©roport√©es
### ÿßŸÑŸÑŸàÿßÿ° ÿßŸÑÿ£ŸàŸÑ ŸÑŸÑŸÖÿ¥ÿßÿ© ÿßŸÑŸÖÿ≠ŸÖŸàŸÑÿ© ÿ¨ŸàÿßŸã

**CLASSIFI√â - USAGE MILITAIRE UNIQUEMENT**

---

*Guide g√©n√©r√© avec [Claude Code](https://claude.com/claude-code)*
